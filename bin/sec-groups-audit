#!/bin/bash
# sec-groups-audit
#
# lists all security groups, used groups, then unused security groups

echo 'listing all security groups' && sleep 1
aws ec2 describe-security-groups --query 'SecurityGroups[*].{Name:GroupName,ID:GroupId}'  --output table | tr '\t' '\n'

echo 
echo 'listing used sec groups' && sleep 2;
aws ec2 describe-instances --query 'Reservations[*].Instances[*].SecurityGroups[*].GroupId' --output text | tr '\t' '\n' | sort | uniq

echo 
echo 'listing UNUSED sec groups' && sleep 2;
comm -23  <(aws ec2 describe-security-groups --query 'SecurityGroups[*].GroupId'  --output text | tr '\t' '\n'| sort) <(aws ec2 describe-instances --query 'Reservations[*].Instances[*].SecurityGroups[*].GroupId' --output text | tr '\t' '\n' | sort | uniq)

echo
echo 'done';

